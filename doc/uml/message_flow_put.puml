@startuml message_flow_put

actor user as "User"
participant client as "Client"
participant server as "API server"
participant wex as "Exchange"

queue qw as "Work Q" #lightgrey
collections work as "Work" #lightgrey

queue qs as "Scan Q" #lightblue
collections scan as "Scanners" #lightblue

user -> client : PUT(filelist,target)
activate client
client -> server : PUT(filelist,target,id)
deactivate client
activate server
server -> wex : key=work.put\nmsg=(filelist,id)
deactivate server
activate wex
wex -> qw : key=work.put\nmsg=(filelist,id)
deactivate wex
activate qw
qw -> work : key=work.put\nmsg=(filelist,id)
deactivate qw
activate work
loop #lightgrey for subfilelist in filelist
    work -> wex : key=scan.scan\nmsg=(subfilelist,id)
    deactivate work
    activate wex
end
wex -> qs : key=scan.scan\nmsg=(filelist,id)
deactivate wex
activate qs
qs -> scan : key=scan.scan\nmsg=(filelist,id)
deactivate qs
activate scan
loop #lightgrey for file in filelist 
    alt file is directory
        scan -> wex : key=scan.scan\nmsg=(file,id)
        activate wex
    else else
        scan -> scan : add file to\nscanned_list
    end
end
scan -> wex : key=scan.complete\nmsg=(scanned_list,id)
deactivate scan
wex -> qs : key=scan.scan\nmsg=(filelist,id)
deactivate wex
activate qs
qs -> scan : key=scan.scan\nmsg=(filelist,id)
deactivate qs
activate scan
loop #lightgrey for file in filelist 
    scan -> scan : add file to\nscanned_list
end
scan -> wex : key=scan.complete\nmsg=(scanned_list,id)
deactivate scan
@enduml