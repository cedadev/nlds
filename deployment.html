<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deployment &mdash; Near-line Data Store Server 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/icon-black.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Near Line Data Store (NLDS)" href="specification.html" />
    <link rel="prev" title="Examples" href="server-config/examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Near-line Data Store Server
            <img src="_static/nlds.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="home.html">CEDA Near-Line Data Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="home.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="system-status.html">Using the system status page</a></li>
<li class="toctree-l1"><a class="reference internal" href="server-config/server-config.html">The server config file</a></li>
<li class="toctree-l1"><a class="reference internal" href="server-config/examples.html">Server config examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#images">Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="#common-deployment-configurations">Common Deployment Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-server">API Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tape-keys">Tape Keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="#migrations">Migrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging-with-fluentbit">Logging with Fluentbit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scaling">Scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changing-ownership-of-files">Changing ownership of files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#archive-put-cronjob">Archive Put Cronjob</a></li>
<li class="toctree-l2"><a class="reference internal" href="#staging-deployment">Staging Deployment</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="specification.html">Specification document</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/cta-emulator.html">Setting up a CTA tape emulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/alembic-migrations.html">Database Migrations with Alembic</a></li>
<li class="toctree-l1"><a class="reference internal" href="coverage/coverage-report.html">Test coverage report</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api-reference/nlds-processors.html">NLDS Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-reference/nlds-server.html">NLDS Server</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Near-line Data Store Server</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Deployment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/deployment.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="deployment">
<h1>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline"></a></h1>
<p>The NLDS is deployed as a collection of containers on the JASMIN rancher cluster
‘wigbiorg’, a public-facing Kubernetes cluster hosted by JASMIN.</p>
<p>Due to the microservice architecture the level to apply the containerisation was
immediately clear - each microservice sits in its own container. There are
therefore nine different containers that make up the deployment of the NLDS,
eight for the consumers and one additional container for the FastAPI server:</p>
<ol class="arabic simple">
<li><p>FastAPI Server</p></li>
<li><p>Worker (router)</p></li>
<li><p>Indexer</p></li>
<li><p>Catalog</p></li>
<li><p>Transfer-Put</p></li>
<li><p>Transfer-Get</p></li>
<li><p>Logging</p></li>
<li><p>Archive-Put</p></li>
<li><p>Archive-Get</p></li>
</ol>
<p>The FastAPI server is defined and deployed in the <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-server-deploy">nlds-server-deploy</a>
repository in gitlab and the latter 8 are similarly defined and deployed in
the <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy">nlds-consumers-deploy</a>
repository. All have subtly different configurations and dependencies, which can
be gleamed in detail by looking at the configuration yaml files and helm chart
in the repos, but are also, mercifully, described below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All of the following describes the deployment set up for the <cite>production</cite>
environment. The setup for the staging/beta testing environment is very
similar but not <cite>quite</cite> the same, so the differences will be summarised in
the <a class="reference internal" href="#staging"><span class="std std-ref">Staging Deployment</span></a> section.</p>
</div>
<div class="section" id="images">
<h2>Images<a class="headerlink" href="#images" title="Permalink to this headline"></a></h2>
<p>The above containers do not all run on the same image, but are sub-divided into
three specific roles:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-server-deploy/-/tree/master/images/Dockerfile">Generic Server</a>: <code class="docutils literal notranslate"><span class="pre">nlds/app</span></code></p></li>
<li><p><a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/tree/master/images/consumer/Dockerfile">Generic Consumer</a>: <code class="docutils literal notranslate"><span class="pre">nlds-consumers/consumer</span></code></p></li>
<li><p><a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/tree/master/images/archiver/Dockerfile">Tape Consumer</a>: <code class="docutils literal notranslate"><span class="pre">nlds-consumers/archiver</span></code></p></li>
</ol>
<p>The string after each of these corresponds to the image’s location on CEDA’s
Harbor registry (and therefore what tag/registry address to use to <code class="docutils literal notranslate"><span class="pre">docker</span>
<span class="pre">pull</span></code> each of them). As may be obvious, the FastAPI server runs on the
<code class="docutils literal notranslate"><span class="pre">Generic</span> <span class="pre">Server</span></code> image and contains an installation of <code class="docutils literal notranslate"><span class="pre">asgi</span></code>, building upon
the <code class="docutils literal notranslate"><span class="pre">asgi</span></code> <a class="reference external" href="https://gitlab.ceda.ac.uk/cedaci/base-images/-/tree/main/asgi">base-image</a>,
to actually run the server. The rest run on the <code class="docutils literal notranslate"><span class="pre">Generic</span> <span class="pre">Consumer</span></code> image,
which has an installation of the NLDS repo, along with its dependencies, to
allow it to run a given consumer. The only dependency which isn’t included is
<code class="docutils literal notranslate"><span class="pre">xrootd</span></code> as it is a very large and long installation process and unnecessary
to the running of the non-tape consumers. Therefore the <code class="docutils literal notranslate"><span class="pre">Tape</span> <span class="pre">Consumer</span></code> image
was created, which appropriately builds upon the <code class="docutils literal notranslate"><span class="pre">Geneic</span> <span class="pre">Consumer</span></code> image with
an additional installation of <code class="docutils literal notranslate"><span class="pre">xrootd</span></code> with which to run tape commands. The
two tape consumers, <code class="docutils literal notranslate"><span class="pre">Archive-Put</span></code> and <code class="docutils literal notranslate"><span class="pre">Archive-Get</span></code>, run on containers using
this image.</p>
<p>The two consumer containers run as the user NLDS, which is an official JASMIN
user at <code class="docutils literal notranslate"><span class="pre">uid=7054096</span></code> and is baked into the container (i.e. unconfigurable).
Relatedly, every container runs with config associating the NLDS user with
supplemental groups, the list of which constitutes every group-workspace on
JASMIN. The list was generated with the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">homer</span><span class="o">.</span><span class="n">esc</span><span class="o">.</span><span class="n">rl</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span> <span class="o">-</span><span class="n">b</span> <span class="s2">&quot;ou=ceda,ou=Groups,o=hpc,dc=rl,dc=ac,dc=uk&quot;</span>
</pre></div>
</div>
<p>This will need to be periodically rerun and the output reformatted to update the
list of <code class="docutils literal notranslate"><span class="pre">supplementalGroups</span></code> in <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/blob/master/conf/common.yaml?ref_type=heads#L14-515">this config file</a>.</p>
<p>Each of the containers will also have specific config and specific deployment
setup to help the container perform its particular task its particular task.</p>
</div>
<div class="section" id="common-deployment-configurations">
<h2>Common Deployment Configurations<a class="headerlink" href="#common-deployment-configurations" title="Permalink to this headline"></a></h2>
<p>There are several common deployment configurations (CDC) required to perform
tasks, which some, or all, of the containers make use of to function.</p>
<p>The most commonly used is the <code class="docutils literal notranslate"><span class="pre">nslcd</span></code> pod which provides the containers with
up-to-date uid and gid information from the LDAP servers. This directly uses the
<a class="reference external" href="https://gitlab.ceda.ac.uk/jasmin-notebooks/jasmin-notebooks/-/tree/master/images/nslcd">nslcd</a>
image developed for the notebook server, and runs as a side-car in every
deployed pod to periodically poll the LDAP servers to provide names and
permissions information to the main container in the pod (the consumer) so that
file permissions can be handled properly. In other words, it ensures the
<code class="docutils literal notranslate"><span class="pre">passwd</span></code> file on the consumer container is up to date, and therefore that the
aforementioned supplementalGroups are properly respected.</p>
<p>Another CDC used across all pods is the rabbit configuration, details of which
can be found in <a class="reference internal" href="server-config/server-config.html"><span class="doc">Server config</span></a>.</p>
<p>An additional CDC used by the microservices which require reading from or writing
to the JASMIN filesystem are the filesystem mounts, which will mount the group
workspaces (in either read or write mode) onto the appropriate path (<code class="docutils literal notranslate"><span class="pre">/gws</span></code> or
<code class="docutils literal notranslate"><span class="pre">/group_workspaces</span></code>). This is used by the following containers:</p>
<ul class="simple">
<li><p>Transfer-Put</p></li>
<li><p>Transfer-Get</p></li>
<li><p>Indexer</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is the intention to eventually include several more directories into the
mounting (<code class="docutils literal notranslate"><span class="pre">/xfc</span></code>, <code class="docutils literal notranslate"><span class="pre">/home</span></code>) but this is not currently possible with the
version of Kubernetes installed on wigbiorg</p>
</div>
<p>A further CDC is the PostgreSQL configuration, which is obviously required by
the database-interacting consumers (Catalog and Monitor) and, again, fully
described in <a class="reference internal" href="server-config/server-config.html"><span class="doc">Server config</span></a>. The production system uses the
databases <code class="docutils literal notranslate"><span class="pre">nlds_catalog</span></code> and <code class="docutils literal notranslate"><span class="pre">nlds_monitor</span></code> on the Postgres server
<code class="docutils literal notranslate"><span class="pre">db5.ceda.ac.uk</span></code> hosted and maintained by CEDA. However, an additional part of
this configuration is running any database migrations to the database schema is
up to date. This will be discussed in more detail in section
<a class="reference internal" href="#db-migration"><span class="std std-ref">Migrations</span></a>.</p>
<p>There are some slightly more complex deployment configurations involved in the
rest of the setup, which are described below.</p>
</div>
<div class="section" id="api-server">
<span id="id1"></span><h2>API Server<a class="headerlink" href="#api-server" title="Permalink to this headline"></a></h2>
<p>The NLDS API server, as mentioned above, was written using FastAPI. In a local
development environment this is served using <code class="docutils literal notranslate"><span class="pre">uvicorn</span></code>, but for the production
deployment the <cite>base-image &lt;https://gitlab.ceda.ac.uk/cedaci/base-images/-/tree/main/asgi&gt;</cite>
base-image is used, which runs the server instead with <code class="docutils literal notranslate"><span class="pre">guincorn</span></code>. They are
functionally identical so this is not a problem per se, just something to be
aware of. The NLDS API helm deployment is an extension of the standard <a class="reference external" href="https://gitlab.ceda.ac.uk/cedaci/base-images/-/tree/main/fast-api">FastAPI helm chart</a>.</p>
<p>On production, this API server sits facing the public internet behind an NGINX
reverse-proxy, handled by the standard <a class="reference external" href="https://gitlab.ceda.ac.uk/cedaci/helm-charts/-/tree/master/nginx">nginx helm chart</a>
in the <code class="docutils literal notranslate"><span class="pre">cedaci/helm-charts</span></code> repo. It is served to the domain
<a class="reference external" href="https://nlds.jasmin.ac.uk">https://nlds.jasmin.ac.uk</a>, with the standard NLDS
API endpoints extending from that (such as <code class="docutils literal notranslate"><span class="pre">/docs</span></code>, <code class="docutils literal notranslate"><span class="pre">/system/status</span></code>). The
NLDS API also has an additional endpoint (<code class="docutils literal notranslate"><span class="pre">/probe/healthz</span></code>) for the Kubernetes
liveness probe to periodically ping to ensure the API is alive, and that the
appropriate party is notified if it goes down. Please note, this is not a
deployment specific endpoint and will also exist on any local development
instances.</p>
</div>
<div class="section" id="tape-keys">
<span id="id2"></span><h2>Tape Keys<a class="headerlink" href="#tape-keys" title="Permalink to this headline"></a></h2>
<p>The CERN Tape Archive (CTA) instance at STFC requires the use of authentication
to access the different tape pools and tape instances. This is done through
Kerberos on the backend and requires the use of a forwardable keytab file with
appropriate permissions. From the perspective of the NLDS this is actually quite
simple, Scientific Computing (SCD) provide a string to put into a keytab (text)
file which describes the CTA user and authentication and must have unix octal
permissions 600 (i.e. strictly user read-writable). Finally two xrootd-specific
environment variables must be created:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XrdSecPROTOCOL</span><span class="o">=</span><span class="n">sss</span>
<span class="n">XrdSecSSSKT</span><span class="o">=</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">keytab</span><span class="o">/</span><span class="n">file</span>
</pre></div>
</div>
<p>The problem arises with the use of Kubernetes, wherein the keytab content string
must be kept secret. This is handled in the CEDA gitlab deployment process
through the use of git-crypt (see <a class="reference external" href="https://gitlab.ceda.ac.uk/cedaci/ci-tools/-/blob/master/docs/setup-kubernetes-project.md#including-deployment-secrets-in-a-project">here</a>
for more details) to encrypt and Kubernetes secrets to decrypt at deployment
time. Unfortunately permissions can’t be set, no changed, on files made by
Kubernetes secrets, so to get the keytab in the right place with the right
permissions the deployment utilises an init-container to copy the secret key to
a new file and then alter permissions on it to 600.</p>
</div>
<div class="section" id="migrations">
<span id="db-migration"></span><h2>Migrations<a class="headerlink" href="#migrations" title="Permalink to this headline"></a></h2>
<p>As described in <a class="reference internal" href="development/alembic-migrations.html"><span class="doc">Database Migrations with Alembic</span></a>, the NLDS uses Alembic for
database migrations. During the deployment these are done as an initial step
before any of the consumers are updated, so that nothing attempts to use the new
schema before the database has been migrated, and this is implemented through
two mechanisms in the deployment:</p>
<ol class="arabic">
<li><p>An init-container on the catalog, which has the config for both the catalog
and montioring DBs, which has alembic installed and calls:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alembic</span> <span class="n">upgrade</span> <span class="n">head</span>
</pre></div>
</div>
</li>
<li><p>The catalog container deployment running first (alongside the logging) before
all the other container deployments.</p></li>
</ol>
<p>This means that if the database migration fails for whatever reason, the whole
deployment stops and the migration issue can be investigated through the logs.</p>
</div>
<div class="section" id="logging-with-fluentbit">
<span id="logging"></span><h2>Logging with Fluentbit<a class="headerlink" href="#logging-with-fluentbit" title="Permalink to this headline"></a></h2>
<p>The logging for the NLDS, as laid out in the specification, was originally
designed to concentrate logs onto a single container for ease of perusal.
Unfortunately, due to constraints of the Kubernetes version employed, the
container has only limited, temporary storage capacity (the memory assigned from
the cluster controller) and no means of attaching a more persistent volume to
store logs in long-term.</p>
<p>The, relatively new, solution that exists on the CEDA cluster is the use of
<code class="docutils literal notranslate"><span class="pre">fluentd</span></code>, and more precisely <a class="reference external" href="https://fluentbit.io/how-it-works/">fluentbit</a>,
to aggregate logs from the NLDS logging microservice and send them to a single
external location running <code class="docutils literal notranslate"><span class="pre">fluentd</span></code> – currently the stats-collection virtual
machine run on JASMIN. Each log sent to the <code class="docutils literal notranslate"><span class="pre">fluentd</span></code> service is tagged with a
string representing the particular microservice log file it was collected from,
e.g. the logs from the indexer microservice on the staging deployment are tagged
as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nlds_staging_index_q_log</span>
</pre></div>
</div>
<p>This is practically achieved through the use of a sidecar – a further container
running in the same pod as the logging container – running the <code class="docutils literal notranslate"><span class="pre">fluentbit</span></code>
image as defined by the <a class="reference external" href="https://gitlab.ceda.ac.uk/cedaci/helm-charts">fluentbit helm chart</a>.
The full <code class="docutils literal notranslate"><span class="pre">fluentbit</span></code> config, including the full list of tags, can be found
<a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/tree/master/conf/logger">in the logging config yamls</a>.
When received by the fluentd server, each tagged log is collated into a larger
log file for help with debugging at some later date. The log files on the
logging microservice’s container are rotated according to size, and so should
not exceed the pod’s allocated memory limit.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fluentbit</span></code> service is still in its infancy and subject to change at
short notice as the system &amp; helm chart get more widely adopted. For example,
the length of time log files are kept on the stats machine has not been
finalised yet.</p>
</div>
<p>While the above is true for long term log storage, the rancher interface for the
Kubernetes cluster can still be used to check the output logs of each consumer
in the standard way for quick diagnosis of problems with the NLDS.</p>
</div>
<div class="section" id="scaling">
<span id="id3"></span><h2>Scaling<a class="headerlink" href="#scaling" title="Permalink to this headline"></a></h2>
<p>A core part of the design philosophy of the NLDS was its microservice
architecture, which allows for any of the microservices to be scaled out in an
embarrassingly parallelisable way to meet changing demand. This is easily
achieved in Kubernetes through simply spinning up additional containers for a
given microservice using the <code class="docutils literal notranslate"><span class="pre">replicaCount</span></code> <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/blob/master/chart/values.yaml?ref_type=heads#L21">parameter</a>.
By default this value is 1 but has been increased for certain microservices
deemed to be bottlenecks during beta testing, notably the <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/blob/master/conf/transfer_put/common.yaml?ref_type=heads#L17">Transfer-Put microservice</a>
where it is set to 8 and the Transfer-Get where is set to 2.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While correct at time of writing, these values are subject to change – it
may be that other microservices are found which require scaling and those
above do not require as many replicas as currently allocated.</p>
<p>An ideal solution would be to automatically scale the deployments based on
the size of a <code class="docutils literal notranslate"><span class="pre">Rabbit</span></code> queue for a given microservice, and while this is
<cite>in theory</cite> <a class="reference external" href="https://ryanbaker.io/2019-10-07-scaling-rabbitmq-on-k8s/">possible</a>,
this was not possible with the current installation of Kubernetes without
additional plugins, namely <code class="docutils literal notranslate"><span class="pre">Prometheus</span></code>.</p>
</div>
<p>The other aspect of scaling is the resource requested by each of the pods, which
have current <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/blob/master/conf/common.yaml?ref_type=heads#L7">default values</a>
and an exception of greater resource for the transfer processors. The values for
these were arrived at by using the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">top</span> <span class="n">pod</span> <span class="o">-</span><span class="n">n</span> <span class="p">{</span><span class="n">NLDS_NAMESPACE</span><span class="p">}</span>
</pre></div>
</div>
<p>within the kubectl shell on the appropriate rancher cluster (accessible via the
shell button in the top right, or shortcut <code class="code docutils literal notranslate">Ctrl + `</code>). <code class="docutils literal notranslate"><span class="pre">{NLDS_NAMESPACE}</span></code> will need
to be replaced with the appropriate namespace for the cluster you are on, i.e.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">top</span> <span class="n">pod</span> <span class="o">-</span><span class="n">n</span> <span class="n">nlds</span>                     <span class="c1"># on wigbiorg</span>
<span class="n">kubectl</span> <span class="n">top</span> <span class="n">pod</span> <span class="o">-</span><span class="n">n</span> <span class="n">nlds</span><span class="o">-</span><span class="n">consumers</span><span class="o">-</span><span class="n">master</span>    <span class="c1"># for consumers on staging cluster</span>
<span class="n">kubectl</span> <span class="n">top</span> <span class="n">pod</span> <span class="o">-</span><span class="n">n</span> <span class="n">nlds</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">master</span>          <span class="c1"># for api-server on staging cluster</span>
</pre></div>
</div>
<p>and, as before, these will likely need to be adjusted as understanding of the
actual resource use of each of the microservices evolves.</p>
</div>
<div class="section" id="changing-ownership-of-files">
<span id="chowning"></span><h2>Changing ownership of files<a class="headerlink" href="#changing-ownership-of-files" title="Permalink to this headline"></a></h2>
<p>A unique problem arose in beta testing where the NLDS was not able to change
ownership of the files downloaded during a <code class="docutils literal notranslate"><span class="pre">get</span></code> to the user that requested them
from within a container that was not allowed to run as root. As such, a solution
was required which allowed a very specific set of privileges to be escalated
without leaving any security vulnerabilities open.</p>
<p>The solution found was to include an additional binary in the
<code class="docutils literal notranslate"><span class="pre">Generic</span> <span class="pre">Consumer</span></code> image - <code class="docutils literal notranslate"><span class="pre">chown_nlds</span></code> - which has the <code class="docutils literal notranslate"><span class="pre">setuid</span></code>
permissions bit set and is therefore able to change directories. To minimise
exposed attack surface, the binary was compiled from a <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/blob/master/images/consumer/chown_nlds.rs?ref_type=heads">rust script</a>
which allows only the <code class="docutils literal notranslate"><span class="pre">chown</span></code>-ing of files owned by the NLDS user (on JASMIN
<code class="docutils literal notranslate"><span class="pre">uid=7054096</span></code>). Additionally, the target must be a file or directory and the
<code class="docutils literal notranslate"><span class="pre">uid</span></code> being changed to must be greater than 1024 to avoid clashes with system
<a href="#id4"><span class="problematic" id="id5">``</span></a>uid``s. This binary will only execute on any containers where the appropriate
security context is set, notably:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">securityContext</span><span class="p">:</span>
    <span class="n">allowPrivilegeEscalation</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">add</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">CHOWN</span>
</pre></div>
</div>
<p>which in the NLDS deployment helm chart is only set for the <code class="docutils literal notranslate"><span class="pre">Transfer-Get</span></code>
containers/pods.</p>
</div>
<div class="section" id="archive-put-cronjob">
<span id="archive-put"></span><h2>Archive Put Cronjob<a class="headerlink" href="#archive-put-cronjob" title="Permalink to this headline"></a></h2>
<p>The process by which the archive process is started has been automated for this
deployment, running as a <a class="reference external" href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">Kubernetes cronjob</a>
every 12 hours at midnight and midday. The Helm config controlling this can be
seen <a class="reference external" href="https://gitlab.ceda.ac.uk/cedadev/nlds-consumers-deploy/-/blob/master/conf/archive_put/common.yaml?ref_type=heads#L1-3">here</a>.
This cronjob will simply call the <code class="docutils literal notranslate"><span class="pre">send_archive_next()</span></code> entry point, which
sends a message directly to the RabbitMQ exchange for routing to the Catalog.</p>
</div>
<div class="section" id="staging-deployment">
<span id="staging"></span><h2>Staging Deployment<a class="headerlink" href="#staging-deployment" title="Permalink to this headline"></a></h2>
<p>As alluded to earlier, there are two versions of the NLDS running: (a) the
production system on wigbiorg, and (b) the staging/beta testing system on the
staging cluster (<code class="docutils literal notranslate"><span class="pre">ceda-k8s</span></code>). These have similar but slightly different
configurations, the details of which are summarised in the below table. Like
everything on this page, this was true at the time of writing (2024-03-06).</p>
<table class="colwidths-given docutils align-default" id="id7">
<caption><span class="caption-text">Staging vs. Production Config</span><a class="headerlink" href="#id7" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 20%" />
<col style="width: 40%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>System</p></th>
<th class="head"><p>Staging</p></th>
<th class="head"><p>Production</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Tape</p></td>
<td><p>Pre-production instance (<code class="docutils literal notranslate"><span class="pre">antares-preprod-fac.stfc.ac.uk</span></code>)</p></td>
<td><p>Pre-production instance (<code class="docutils literal notranslate"><span class="pre">antares-preprod-fac.stfc.ac.uk</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p>Database</p></td>
<td><p>on <code class="docutils literal notranslate"><span class="pre">db5</span></code> - <code class="docutils literal notranslate"><span class="pre">nlds_{db_name}_staging</span></code></p></td>
<td><p>on <code class="docutils literal notranslate"><span class="pre">db5</span></code> - <code class="docutils literal notranslate"><span class="pre">nlds_{db_name}</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Logging</p></td>
<td><p>To <code class="docutils literal notranslate"><span class="pre">fluentbit</span></code> with tags <code class="docutils literal notranslate"><span class="pre">nlds_statging_{service_name}_log</span></code></p></td>
<td><p>To <code class="docutils literal notranslate"><span class="pre">fluentbit</span></code> with tags <code class="docutils literal notranslate"><span class="pre">nlds_prod_{service_name}_log</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Object store</p></td>
<td><p>Uses the <code class="docutils literal notranslate"><span class="pre">cedaproc-o</span></code> tenancy</p></td>
<td><p>Uses <code class="docutils literal notranslate"><span class="pre">nlds-cache-02-o</span></code> tenancy, <code class="docutils literal notranslate"><span class="pre">nlds-cache-01-o</span></code> also available</p></td>
</tr>
<tr class="row-even"><td><p>API Server</p></td>
<td><p><a class="reference external" href="https://nlds-master.130.246.130.221.nip.io/docs">https://nlds-master.130.246.130.221.nip.io/</a> (firewalled)</p></td>
<td><p><a class="reference external" href="https://nlds.jasmin.ac.uk/docs">https://nlds.jasmin.ac.uk/</a> (public, ssl secured)</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="server-config/examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="specification.html" class="btn btn-neutral float-right" title="Near Line Data Store (NLDS)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2024, Neil Massey &amp; Jack Leland.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #A6C36F;
    }

    .caption-text {
        color: #828C51
    }

    .wy-nav-side {
        background: #1E352F;
    }

    .note {
        background: #BEEF9E
    }
    .admonition-title {
        background: #335145
    }

  </style>


</body>
</html>